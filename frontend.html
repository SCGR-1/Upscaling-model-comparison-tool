<!DOCTYPE html>
<html>
<head>
    <title>Image Upscaler</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #333; margin-bottom: 30px; }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.cancel {
            background: #dc3545;
            margin-left: 10px;
        }
        button.cancel:hover { background: #c82333; }
        .button-group {
            display: flex;
            gap: 10px;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        #status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #result {
            margin-top: 20px;
            text-align: center;
        }
        #preview {
            margin-top: 20px;
            text-align: center;
        }
        #preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #comparison {
            margin-top: 20px;
            display: none;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .comparison-item {
            text-align: center;
        }
        .comparison-item h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        .comparison-item img {
            max-width: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            image-rendering: crisp-edges;
        }
        #comparison img {
            image-rendering: crisp-edges;
        }
        #timer {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin-top: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .comparison-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Image Upscaler</h1>
        
        <form id="upscaleForm">
            <div class="form-group">
                <label for="filename">Image File:</label>
                <select id="filename" name="filename" required>
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <div class="grid">
                <div class="form-group">
                    <label for="backend">Backend:</label>
                    <select id="backend" name="backend">
                        <option value="realesrgan">Real-ESRGAN</option>
                        <option value="pan">PAN</option>
                        <option value="edsr">EDSR</option>
                        <option value="swinir">SwinIR</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scale">Scale:</label>
                    <select id="scale" name="scale">
                        <option value="2">2√ó</option>
                        <option value="3">3√ó</option>
                        <option value="4" selected>4√ó</option>
                        <option value="8">8√ó</option>
                        <option value="16">16√ó</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="batch" name="batch" style="width: auto; margin: 0;">
                    <span>Batch mode (process all images in input/)</span>
                </label>
            </div>
            
            <div class="button-group">
                <button type="submit" id="submitBtn">Upscale Image</button>
                <button type="button" id="cancelBtn" class="cancel" style="display: none;">Cancel</button>
            </div>
        </form>
        
        <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #dee2e6;">
            <h2 style="color: #333; margin-bottom: 20px;">üìä Input Metrics</h2>
            <p style="color: #666; margin-bottom: 15px;">Compute quality metrics for all images in the input/ directory.</p>
            <button type="button" id="computeInputMetricsBtn" style="background: #28a745; width: auto; padding: 12px 24px;">
                Compute Input Metrics
            </button>
            <button type="button" id="cancelInputMetricsBtn" class="cancel" style="display: none; margin-left: 10px;">Cancel</button>
        </div>
        
        <div id="preview"></div>
        <div id="status"></div>
        <div id="timer"></div>
        <div id="comparison"></div>
    </div>
    
    <script>
        // Filter out browser extension errors from console
        const originalError = console.error;
        console.error = function(...args) {
            const msg = args.join(' ');
            // Ignore common browser extension errors
            if (msg.includes('popup.js') || 
                msg.includes('runtime.lastError') || 
                msg.includes('Receiving end does not exist')) {
                return; // Suppress extension errors
            }
            originalError.apply(console, args);
        };
        
        console.log('‚úÖ Application script loaded successfully');
        
        let startTime = null;
        let timerInterval = null;
        let currentRequestId = null;
        let abortController = null;
        
        function updateTimer() {
            if (startTime) {
                const elapsed = (Date.now() - startTime) / 1000;
                const minutes = Math.floor(elapsed / 60);
                const seconds = Math.floor(elapsed % 60);
                const ms = Math.floor((elapsed - Math.floor(elapsed)) * 1000);
                document.getElementById('timer').textContent = 
                    `Processing time: ${minutes}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
            }
        }
        
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 50);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        async function loadImages() {
            console.log('=== loadImages() called ===');
            const select = document.getElementById('filename');
            console.log('Select element:', select);
            if (!select) {
                console.error('Select element not found!');
                return;
            }
            console.log('Current select innerHTML:', select.innerHTML);
            try {
                console.log('Fetching /api/images...');
                const res = await fetch('/api/images');
                console.log('Response received:', res);
                console.log('Response status:', res.status, res.statusText);
                console.log('Response headers:', res.headers);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                const data = await res.json();
                console.log('Parsed JSON data:', data);
                console.log('Images array:', data.images);
                console.log('Images count:', data.images ? data.images.length : 0);
                
                // Clear and rebuild options
                select.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select an image...';
                select.appendChild(defaultOption);
                
                if (data.images && data.images.length > 0) {
                    console.log(`Adding ${data.images.length} image options...`);
                    data.images.forEach((img, index) => {
                        const option = document.createElement('option');
                        option.value = img;
                        option.textContent = img;
                        select.appendChild(option);
                        if (index < 3) console.log(`Added option: ${img}`);
                    });
                    console.log('All options added. Final select.innerHTML length:', select.innerHTML.length);
                    console.log('Select options count:', select.options.length);
                } else {
                    console.warn('No images in response');
                    select.innerHTML = '<option value="">No images found in input/ directory</option>';
                }
            } catch (e) {
                console.error('Failed to load images:', e);
                console.error('Error stack:', e.stack);
                select.innerHTML = '<option value="">Error loading images. Check console for details.</option>';
            }
            console.log('=== loadImages() finished ===');
        }
        
        // Handle batch mode checkbox - disable/enable filename field
        document.getElementById('batch').addEventListener('change', function() {
            const filenameSelect = document.getElementById('filename');
            const isBatch = this.checked;
            filenameSelect.disabled = isBatch;
            filenameSelect.required = !isBatch;
            if (isBatch) {
                filenameSelect.value = '';
                document.getElementById('preview').innerHTML = '';
            }
        });
        
        document.getElementById('filename').addEventListener('change', function() {
            const filename = this.value;
            const preview = document.getElementById('preview');
            if (filename) {
                preview.innerHTML = `<h3>Preview:</h3><img src="/input/${encodeURIComponent(filename)}" alt="Preview">`;
            } else {
                preview.innerHTML = '';
            }
        });
        
        document.getElementById('cancelBtn').addEventListener('click', async () => {
            if (currentRequestId) {
                const status = document.getElementById('status');
                const timer = document.getElementById('timer');
                stopTimer();
                status.className = 'loading';
                status.textContent = 'Cancelling...';
                try {
                    await fetch(`/cancel?request_id=${encodeURIComponent(currentRequestId)}`, { method: 'POST' });
                    if (abortController) {
                        abortController.abort();
                    }
                } catch (e) {
                    console.error('Failed to cancel:', e);
                }
            }
        });

        document.getElementById('upscaleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const status = document.getElementById('status');
            const comparison = document.getElementById('comparison');
            const timer = document.getElementById('timer');
            
            const batch = document.getElementById('batch').checked;
            const filename = batch ? '' : document.getElementById('filename').value;
            const backend = document.getElementById('backend').value;
            const scale = document.getElementById('scale').value;
            
            // Validate: filename required only if not batch mode
            if (!batch && !filename) {
                status.style.display = 'block';
                status.className = 'error';
                status.textContent = 'Please select an image file or enable batch mode.';
                return;
            }
            
            currentRequestId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            abortController = new AbortController();
            
            btn.disabled = true;
            cancelBtn.style.display = 'block';
            status.style.display = 'block';
            status.className = 'loading';
            status.textContent = batch ? 'Processing all images in batch mode... This may take a while.' : 'Processing... This may take a while.';
            comparison.style.display = 'none';
            comparison.innerHTML = '';
            timer.textContent = '';
            startTimer();
            
            try {
                const endpoint = batch ? '/batch' : '/upscale';
                const params = batch 
                    ? `backend=${backend}&scale=${scale}&metrics=true&request_id=${encodeURIComponent(currentRequestId)}`
                    : `filename=${encodeURIComponent(filename)}&backend=${backend}&scale=${scale}&metrics=true&request_id=${encodeURIComponent(currentRequestId)}`;
                const res = await fetch(`${endpoint}?${params}`, {
                    method: 'POST',
                    signal: abortController.signal
                });
                const data = await res.json();
                
                stopTimer();
                
                if (data.success) {
                    if (batch) {
                        // Batch mode results
                        status.className = 'success';
                        status.textContent = `Batch processing complete! Processed ${data.processed_count} images. Output folder: ${data.output_folder}`;
                        timer.textContent = `Total processing time: ${data.processing_time.toFixed(2)} seconds`;
                        comparison.style.display = 'block';
                        
                        let batchHtml = `
                            <div style="margin-top:20px;padding:16px;background:#e7f3ff;border-radius:8px;border:1px solid #b3d9ff">
                                <h3 style="margin-top:0;margin-bottom:16px;color:#333">üì¶ Batch Processing Results</h3>
                                <p><strong>Output folder:</strong> ${data.output_folder}</p>
                                <p><strong>Processed:</strong> ${data.processed_count} images</p>
                                <p><strong>Metrics file:</strong> ${data.metrics_file}</p>
                                ${data.percentiles_file ? `<p><strong>Percentiles file:</strong> ${data.percentiles_file}</p>` : ''}
                            </div>
                        `;
                        
                        if (data.percentiles) {
                            const p = data.percentiles;
                            const pretty = s => {
                                if (s === null || s === undefined) return '‚Äî';
                                if (typeof s === 'number' && (isNaN(s) || !isFinite(s))) return '‚Äî';
                                if (typeof s === 'number') return s.toFixed(4);
                                return String(s);
                            };
                            
                            batchHtml += `
                                <div style="margin-top:20px;padding:16px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6">
                                    <h3 style="margin-top:0;margin-bottom:16px;color:#333">üìä Metrics Percentiles (25th, 50th, 75th)</h3>
                                    <pre style="background:#ffffff;padding:12px;border-radius:6px;overflow:auto;margin:0;font-size:13px;line-height:1.5">
Processing Time:
  Per-image: ${pretty(p.processing_time?.[0])} / ${pretty(p.processing_time?.[1])} / ${pretty(p.processing_time?.[2])} seconds

No-reference metrics (on upscaled images):
  NIQE:     ${pretty(p.no_reference?.NIQE?.[0])} / ${pretty(p.no_reference?.NIQE?.[1])} / ${pretty(p.no_reference?.NIQE?.[2])} (lower is better)
  BRISQUE:  ${pretty(p.no_reference?.BRISQUE?.[0])} / ${pretty(p.no_reference?.BRISQUE?.[1])} / ${pretty(p.no_reference?.BRISQUE?.[2])} (lower is better)
  LaplacianVar: ${pretty(p.no_reference?.LaplacianVar?.[0])} / ${pretty(p.no_reference?.LaplacianVar?.[1])} / ${pretty(p.no_reference?.LaplacianVar?.[2])} (√ó1e6, higher = sharper)
  Tenengrad: ${pretty(p.no_reference?.Tenengrad?.[0])} / ${pretty(p.no_reference?.Tenengrad?.[1])} / ${pretty(p.no_reference?.Tenengrad?.[2])} (higher = sharper)

Downscale Consistency:
  PSNR: ${pretty(p.downscale_consistency?.PSNR?.[0])} / ${pretty(p.downscale_consistency?.PSNR?.[1])} / ${pretty(p.downscale_consistency?.PSNR?.[2])} dB
  SSIM: ${pretty(p.downscale_consistency?.SSIM?.[0])} / ${pretty(p.downscale_consistency?.SSIM?.[1])} / ${pretty(p.downscale_consistency?.SSIM?.[2])}

Deltas vs Bicubic (positive = upscaler better):
  ŒîNIQE: ${pretty(p.deltas_vs_bicubic?.NIQE?.[0])} / ${pretty(p.deltas_vs_bicubic?.NIQE?.[1])} / ${pretty(p.deltas_vs_bicubic?.NIQE?.[2])}
  ŒîBRISQUE: ${pretty(p.deltas_vs_bicubic?.BRISQUE?.[0])} / ${pretty(p.deltas_vs_bicubic?.BRISQUE?.[1])} / ${pretty(p.deltas_vs_bicubic?.BRISQUE?.[2])}
  ŒîLaplacianVar: ${pretty(p.deltas_vs_bicubic?.LaplacianVar?.[0])} / ${pretty(p.deltas_vs_bicubic?.LaplacianVar?.[1])} / ${pretty(p.deltas_vs_bicubic?.LaplacianVar?.[2])} (√ó1e6)
  ŒîTenengrad: ${pretty(p.deltas_vs_bicubic?.Tenengrad?.[0])} / ${pretty(p.deltas_vs_bicubic?.Tenengrad?.[1])} / ${pretty(p.deltas_vs_bicubic?.Tenengrad?.[2])}
  ŒîPSNR: ${pretty(p.deltas_vs_bicubic?.PSNR?.[0])} / ${pretty(p.deltas_vs_bicubic?.PSNR?.[1])} / ${pretty(p.deltas_vs_bicubic?.PSNR?.[2])} dB
  ŒîSSIM: ${pretty(p.deltas_vs_bicubic?.SSIM?.[0])} / ${pretty(p.deltas_vs_bicubic?.SSIM?.[1])} / ${pretty(p.deltas_vs_bicubic?.SSIM?.[2])}
                                    </pre>
                                </div>
                            `;
                        }
                        
                        comparison.innerHTML = batchHtml;
                    } else {
                        // Single image mode
                        let infoText = `Scale: ${data.scale}x`;
                        if (data.effective_scale !== undefined && data.effective_scale !== data.scale) {
                            infoText += ` (effective: ${data.effective_scale}x)`;
                        }
                        if (data.capped) {
                            infoText += ' [CAPPED]';
                        }
                        if (data.warning) {
                            infoText += ` - ${data.warning}`;
                        }
                        status.className = 'success';
                        status.textContent = `Success! Output saved as: ${data.output_filename}. ${infoText}`;
                        timer.textContent = `Processing time: ${data.processing_time.toFixed(2)} seconds`;
                        comparison.style.display = 'block';
                        const afterTitle = data.effective_scale !== undefined && data.effective_scale !== data.scale 
                            ? `After (${data.effective_scale}x${data.capped ? ' - CAPPED' : ''})` 
                            : `After (${scale}x${data.capped ? ' - CAPPED' : ''})`;
                        comparison.innerHTML = `
                        <div class="comparison-grid">
                            <div class="comparison-item">
                                <h3>Before</h3>
                                <img src="/input/${encodeURIComponent(filename)}" alt="Original">
                            </div>
                            <div class="comparison-item">
                                <h3>${afterTitle}</h3>
                                <img src="/output/${encodeURIComponent(data.output_filename)}" alt="Upscaled">
                            </div>
                        </div>
                        <div style="margin-top:12px;padding:10px;background:#fff3cd;border:1px solid #ffc107;border-radius:4px;font-size:13px;color:#856404">
                            <strong>üí° Tip:</strong> View images at full resolution (100% zoom) to see sharpness differences. 
                            ${data.scale >= 8 ? 'High-scale upscales (8√ó/16√ó) work best on high-detail source images and may take longer to process.' : ''}
                        </div>
                    `;
                    
                    if (data.metrics) {
                        try {
                            const m = data.metrics;
                            const pretty = s => {
                                if (s === null || s === undefined) return '‚Äî';
                                if (typeof s === 'number' && (isNaN(s) || !isFinite(s))) return '‚Äî';
                                if (typeof s === 'number') return s.toFixed(4);
                                return String(s);
                            };
                            
                            let metricsHtml = `
                                <div style="margin-top:20px;padding:16px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6">
                                    <h3 style="margin-top:0;margin-bottom:16px;color:#333">üìä Quality Metrics</h3>
                                    <pre style="background:#ffffff;padding:12px;border-radius:6px;overflow:auto;margin:0;font-size:13px;line-height:1.5">
Availability: ${JSON.stringify(m.availability || {}, null, 2)}

Note: Lower is better for NIQE and BRISQUE. Higher is better for all others.
LaplacianVar is scaled by 1e6 for readability.

No-reference on Upscaled:
  NIQE: ${pretty(m.no_reference?.NIQE)} (lower is better)
  BRISQUE: ${pretty(m.no_reference?.BRISQUE)} (lower is better)
  LaplacianVar: ${pretty(m.no_reference?.LaplacianVar)} (√ó1e6, higher = sharper)
  Tenengrad: ${pretty(m.no_reference?.Tenengrad)} (higher = sharper)

Downscale Consistency (compare downscaled-upscaled vs original):
  PSNR: ${pretty(m.downscale_consistency?.PSNR)} dB
  SSIM: ${pretty(m.downscale_consistency?.SSIM)}
`;
                            
                            if (m.baseline_bicubic) {
                                metricsHtml += `
Baseline Bicubic @ same size:
  NIQE: ${pretty(m.baseline_bicubic.NIQE)}
  BRISQUE: ${pretty(m.baseline_bicubic.BRISQUE)}
  LaplacianVar: ${pretty(m.baseline_bicubic.LaplacianVar)} (√ó1e6)
  Tenengrad: ${pretty(m.baseline_bicubic.Tenengrad)}
  PSNR: ${pretty(m.baseline_bicubic.Downscale_PSNR)} dB
  SSIM: ${pretty(m.baseline_bicubic.Downscale_SSIM)}
`;
                            }
                            
                            if (m.deltas_vs_bicubic) {
                                metricsHtml += `
Deltas vs Bicubic (positive = your upscaler better; NIQE/BRISQUE inverted):
  ŒîNIQE: ${pretty(m.deltas_vs_bicubic.NIQE)}
  ŒîBRISQUE: ${pretty(m.deltas_vs_bicubic.BRISQUE)}
  ŒîLaplacianVar: ${pretty(m.deltas_vs_bicubic.LaplacianVar)} (√ó1e6)
  ŒîTenengrad: ${pretty(m.deltas_vs_bicubic.Tenengrad)}
  ŒîPSNR: ${pretty(m.deltas_vs_bicubic.PSNR)} dB
  ŒîSSIM: ${pretty(m.deltas_vs_bicubic.SSIM)}
`;
                            }
                            
                            metricsHtml += `                                </pre>
                                </div>`;
                            
                            document.getElementById('comparison').insertAdjacentHTML('beforeend', metricsHtml);
                        } catch (e) {
                            console.error('Error displaying metrics:', e, data.metrics);
                        }
                    } else {
                        console.log('No metrics in response:', data);
                    }
                    }
                } else {
                    throw new Error(data.error || 'Upscaling failed');
                }
            } catch (error) {
                stopTimer();
                if (error.name === 'AbortError' || error.message.includes('cancelled')) {
                    status.className = 'error';
                    status.textContent = 'Processing cancelled by user.';
                } else {
                    status.className = 'error';
                    status.textContent = 'Error: ' + error.message;
                }
                timer.textContent = '';
            } finally {
                btn.disabled = false;
                cancelBtn.style.display = 'none';
                currentRequestId = null;
                abortController = null;
            }
        });
        
        // Input metrics button handler
        document.getElementById('computeInputMetricsBtn').addEventListener('click', async () => {
            const btn = document.getElementById('computeInputMetricsBtn');
            const cancelBtn = document.getElementById('cancelInputMetricsBtn');
            const status = document.getElementById('status');
            const comparison = document.getElementById('comparison');
            const timer = document.getElementById('timer');
            
            currentRequestId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            abortController = new AbortController();
            
            btn.disabled = true;
            cancelBtn.style.display = 'block';
            status.style.display = 'block';
            status.className = 'loading';
            status.textContent = 'Computing input metrics for all images...';
            comparison.style.display = 'none';
            comparison.innerHTML = '';
            timer.textContent = '';
            startTimer();
            
            try {
                const res = await fetch(`/compute-input-metrics?request_id=${encodeURIComponent(currentRequestId)}`, {
                    method: 'POST',
                    signal: abortController.signal
                });
                const data = await res.json();
                
                stopTimer();
                
                if (data.success) {
                    status.className = 'success';
                    status.textContent = `Input metrics computed! Processed ${data.processed_count} images.`;
                    timer.textContent = `Processing time: ${(data.processing_time || 0).toFixed(2)} seconds`;
                    
                    let inputMetricsHtml = `
                        <div style="margin-top:20px;padding:16px;background:#d1ecf1;border-radius:8px;border:1px solid #bee5eb">
                            <h3 style="margin-top:0;margin-bottom:16px;color:#333">üìä Input Metrics Results</h3>
                            <p><strong>Processed:</strong> ${data.processed_count} images</p>
                            <p><strong>Metrics file:</strong> <code>${data.metrics_file}</code></p>
                            ${data.percentiles_file ? `<p><strong>Percentiles file:</strong> <code>${data.percentiles_file}</code></p>` : ''}
                            <p style="margin-top:10px;color:#666;font-size:13px;">The metrics file has been saved to the input/ directory.</p>
                        </div>
                    `;
                    
                    if (data.percentiles) {
                        const p = data.percentiles;
                        const pretty = s => {
                            if (s === null || s === undefined) return '‚Äî';
                            if (typeof s === 'number' && (isNaN(s) || !isFinite(s))) return '‚Äî';
                            if (typeof s === 'number') return s.toFixed(4);
                            return String(s);
                        };
                        
                        inputMetricsHtml += `
                            <div style="margin-top:20px;padding:16px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6">
                                <h3 style="margin-top:0;margin-bottom:16px;color:#333">üìä Metrics Percentiles (25th, 50th, 75th)</h3>
                                <pre style="background:#ffffff;padding:12px;border-radius:6px;overflow:auto;margin:0;font-size:13px;line-height:1.5">
Processing Time:
  Per-image: ${pretty(p.processing_time?.[0])} / ${pretty(p.processing_time?.[1])} / ${pretty(p.processing_time?.[2])} seconds

No-reference metrics:
  NIQE:     ${pretty(p.no_reference?.NIQE?.[0])} / ${pretty(p.no_reference?.NIQE?.[1])} / ${pretty(p.no_reference?.NIQE?.[2])} (lower is better)
  BRISQUE:  ${pretty(p.no_reference?.BRISQUE?.[0])} / ${pretty(p.no_reference?.BRISQUE?.[1])} / ${pretty(p.no_reference?.BRISQUE?.[2])} (lower is better)
  LaplacianVar: ${pretty(p.no_reference?.LaplacianVar?.[0])} / ${pretty(p.no_reference?.LaplacianVar?.[1])} / ${pretty(p.no_reference?.LaplacianVar?.[2])} (√ó1e6, higher = sharper)
  Tenengrad: ${pretty(p.no_reference?.Tenengrad?.[0])} / ${pretty(p.no_reference?.Tenengrad?.[1])} / ${pretty(p.no_reference?.Tenengrad?.[2])} (higher = sharper)
                                </pre>
                            </div>
                        `;
                    }
                    
                    comparison.style.display = 'block';
                    comparison.innerHTML = inputMetricsHtml;
                } else {
                    throw new Error(data.error || 'Failed to compute input metrics');
                }
            } catch (error) {
                stopTimer();
                if (error.name === 'AbortError' || error.message.includes('cancelled')) {
                    status.className = 'error';
                    status.textContent = 'Input metrics computation cancelled by user.';
                } else {
                    status.className = 'error';
                    status.textContent = 'Error: ' + error.message;
                }
                timer.textContent = '';
            } finally {
                btn.disabled = false;
                cancelBtn.style.display = 'none';
                currentRequestId = null;
                abortController = null;
            }
        });
        
        document.getElementById('cancelInputMetricsBtn').addEventListener('click', async () => {
            if (currentRequestId) {
                const status = document.getElementById('status');
                stopTimer();
                status.className = 'loading';
                status.textContent = 'Cancelling...';
                try {
                    await fetch(`/cancel?request_id=${encodeURIComponent(currentRequestId)}`, { method: 'POST' });
                    if (abortController) {
                        abortController.abort();
                    }
                } catch (e) {
                    console.error('Failed to cancel:', e);
                }
            }
        });
        
        // Load images when page is ready
        console.log('=== Script initialization ===');
        console.log('‚úÖ Document readyState:', document.readyState);
        console.log('‚úÖ Window loaded:', window.loaded);
        
        function initImageLoader() {
            console.log('initImageLoader() called');
            const select = document.getElementById('filename');
            console.log('Select element in init:', select);
            if (select) {
                console.log('Select found, calling loadImages()...');
                loadImages();
            } else {
                console.error('Select element not found in init!');
            }
        }
        
        // Try multiple ways to ensure it runs
        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOMContentLoaded event fired');
                initImageLoader();
            });
        } else {
            console.log('Document already ready, calling initImageLoader() immediately');
            initImageLoader();
        }
        
        // Also try on window load as final fallback
        window.addEventListener('load', function() {
            console.log('Window load event fired');
            const select = document.getElementById('filename');
            if (select && (select.options.length === 1 && select.options[0].textContent === 'Loading...')) {
                console.warn('Still showing Loading... on window load, forcing reload...');
                loadImages();
            }
        });
        
        // Fallback timeout
        setTimeout(function() {
            console.log('Timeout fallback triggered (3 seconds)');
            const select = document.getElementById('filename');
            if (select) {
                console.log('Select in timeout:', select);
                console.log('Options count:', select.options.length);
                if (select.options.length > 0) {
                    console.log('First option text:', select.options[0].textContent);
                }
                if (select.options.length === 1 && select.options[0].textContent === 'Loading...') {
                    console.warn('Still showing Loading... after 3s, forcing reload...');
                    loadImages();
                }
            } else {
                console.error('Select element not found in timeout!');
            }
        }, 3000);
    </script>
</body>
</html>